# 审批工作流引擎

> **文档编号**：PRD-0-1
> **所属模块**：全局功能
> **优先级**：P0
> **版本**：v1.0
> **最后更新**：2026-02-27
> **关联文档**：全局配置文件.md、ABAC权限设计.md

---

## 一、功能概述

### 1.1 背景与目标

旗舰版系统中涉及大量需要审批的业务场景（合同审批、费用审批、退租审批、大额操作审批等），当前缺乏统一的审批工作流引擎。本功能提供**可视化流程设计器**，支持灵活配置审批流程，覆盖PC端与移动端（UL小程序），实现业务审批的标准化、自动化。

### 1.2 核心价值

- 统一全系统审批入口，替代各模块独立审批逻辑
- 可视化流程设计，业务人员可自行配置审批流
- 支持复杂审批场景（条件分支、会签、或签、超时催办）
- 与ABAC权限模型联动，实现精细化审批权限控制
- 覆盖移动端审批，提升审批效率

---

## 二、功能范围

### 2.1 适用审批场景

| 业务模块 | 审批场景 | 触发条件 |
|---------|---------|---------|
| 合同管理 | 合同签约审批 | 新建合同提交 |
| 合同管理 | 合同变更审批 | 合同变更申请 |
| 合同管理 | 合同退租审批 | 退租申请提交 |
| 合同管理 | 合同续租审批 | 续租申请提交 |
| 财务管理 | 费用减免审批 | 费用减免申请 |
| 财务管理 | 大额收支审批 | 金额超过配置阈值 |
| 运营管理 | 报修工单审批 | 特殊工单需审批 |
| 运营管理 | 公共资源预约审批 | 预约提交（可配置是否需审批） |
| 渠道管理 | 中介备案审批 | 中介提交备案 |
| 渠道管理 | 佣金结算审批 | 佣金结算单生成 |

### 2.2 功能模块

```
审批工作流引擎
├── 流程设计器（可视化）
│   ├── 节点配置（审批人/条件/操作）
│   ├── 连线配置（条件分支）
│   └── 流程模板管理
├── 流程执行引擎
│   ├── 流程实例管理
│   ├── 任务分发与通知
│   ├── 超时催办与自动处理
│   └── 流程回退与撤回
├── 审批工作台
│   ├── 待我审批
│   ├── 我已审批
│   ├── 我发起的
│   └── 抄送我的
└── 审批统计
    ├── 审批效率报表
    └── 超时统计
```

---

## 三、流程设计器

### 3.1 设计器界面

**入口**：系统设置 → 审批工作流

**操作流程**：
1. 选择业务类型（如"合同签约审批"）
2. 拖拽节点到画布，连线形成流程
3. 配置每个节点的审批人/审批规则
4. 保存并发布流程

### 3.2 节点类型

| 节点类型 | 图标 | 说明 | 配置项 |
|---------|------|------|--------|
| **发起人节点** | 圆形-绿色 | 流程起点，由业务操作自动触发 | 发起人范围、可撤回规则 |
| **审批人节点** | 矩形-蓝色 | 指定审批人进行审批 | 审批人指定方式、审批方式（会签/或签）、超时规则 |
| **条件分支节点** | 菱形-橙色 | 根据业务数据条件分流 | 分支条件表达式 |
| **抄送节点** | 矩形-灰色 | 通知指定人员，无需审批动作 | 抄送人指定方式 |
| **结束节点** | 圆形-红色 | 流程终点 | 审批通过/拒绝后的业务动作 |

### 3.3 审批人指定方式

| 方式 | 说明 | 适用场景 |
|------|------|---------|
| 指定人员 | 固定指定1~N个员工 | 小团队固定审批人 |
| 指定角色 | 具有指定角色标签的员工 | 按职能审批 |
| 部门主管 | 发起人所在部门的主管 | 逐级审批 |
| 连续多级主管 | 发起人的直属主管→上级主管→... | 多层级审批 |
| 发起人自选 | 发起时由发起人自行选择审批人 | 灵活场景 |
| ABAC策略匹配 | 基于ABAC策略引擎动态匹配 | 复杂权限场景（如大额合同自动路由总经理） |

### 3.4 审批方式

| 方式 | 说明 | 规则 |
|------|------|------|
| **或签** | 任一审批人同意即通过 | 一人通过→节点通过，一人拒绝→节点拒绝 |
| **会签** | 所有审批人都需审批 | 全部通过→节点通过，任一拒绝→节点拒绝 |
| **依次审批** | 按顺序逐个审批 | 按指定顺序依次审批 |

### 3.5 条件分支

支持基于业务数据字段设置条件表达式：

```
条件分支示例：
├── 条件1：合同金额 > 100万 → 路由到"总经理审批"节点
├── 条件2：合同金额 > 50万 → 路由到"副总审批"节点
└── 默认：→ 路由到"部门主管审批"节点
```

**支持的条件运算符**：等于、不等于、大于、小于、包含、不包含、为空、不为空、属于（范围）

**支持的条件字段**：各业务模块的核心字段（金额、类型、园区、部门等）

### 3.6 超时规则

| 配置项 | 说明 |
|--------|------|
| 超时时间 | N小时/N天 未处理视为超时 |
| 超时提醒 | 超时前N小时发送催办通知（多渠道：站内信+短信+微信+UL推送） |
| 超时动作 | 自动通过 / 自动拒绝 / 自动转交上级 / 无（仅提醒） |

### 3.7 流程模板

- 系统预置常用审批流程模板（合同审批、费用审批等）
- 支持从模板创建新流程
- 支持自定义流程另存为模板

---

## 四、流程执行引擎

### 4.1 流程实例生命周期

```
[已创建] → [审批中] → [已通过] / [已拒绝]
                │
                ├── [已撤回]（发起人主动撤回）
                └── [已超时]（超时自动处理）
```

### 4.2 审批操作

| 操作 | 说明 | 权限 |
|------|------|------|
| **同意** | 审批通过，流转到下一节点 | 当前节点审批人 |
| **拒绝** | 审批拒绝，必须填写拒绝原因 | 当前节点审批人 |
| **转交** | 将审批任务转交给其他人 | 当前节点审批人 |
| **加签** | 在当前节点增加审批人 | 当前节点审批人 |
| **撤回** | 发起人撤回审批（仅在下一节点未处理前可撤回） | 发起人 |
| **催办** | 发送催办通知给当前审批人 | 发起人 |

### 4.3 审批意见

- 同意/拒绝时必须填写审批意见（可配置是否必填）
- 支持附件上传（审批佐证材料）
- 审批意见全流程可见（审批时间线展示）

### 4.4 与业务系统联动

| 审批结果 | 业务联动动作 |
|---------|-------------|
| 合同审批通过 | 合同状态→"执行中"；房源状态→"在租"；触发账单生成；平台同步 |
| 合同审批拒绝 | 合同状态→"已驳回"；房源释放锁定；通知发起人 |
| 退租审批通过 | 触发退租流程；房源标记"即将空出"；Push到平台 |
| 费用审批通过 | 生成账单/收据；触发支付通知 |

---

## 五、审批工作台

### 5.1 PC端工作台

**入口**：顶部导航栏"审批"图标（带红色角标显示待审数量）

**页签划分**：

| 页签 | 内容 | 排序 |
|------|------|------|
| 待我审批 | 需要当前用户审批的任务列表 | 按紧急程度+提交时间排序 |
| 我已审批 | 当前用户已处理的审批记录 | 按处理时间倒序 |
| 我发起的 | 当前用户发起的审批申请 | 按发起时间倒序 |
| 抄送我的 | 抄送给当前用户的审批信息 | 按抄送时间倒序 |

**列表字段**：审批标题、业务类型、发起人、发起时间、当前节点、审批状态、操作

### 5.2 移动端审批（UL小程序）

- 与PC端数据完全同步
- 支持UL推送→直接打开审批详情→一键审批
- 审批详情页展示业务摘要信息（无需跳转PC端查看完整数据）
- 详细交互见 PRD-12-2（审批处理.md）

---

## 六、审批统计

### 6.1 审批效率报表

| 指标 | 说明 |
|------|------|
| 平均审批时长 | 按业务类型/审批人维度统计 |
| 超时审批占比 | 超时审批次数 / 总审批次数 |
| 审批通过率 | 通过次数 / 总审批次数 |
| 审批量趋势 | 按日/周/月统计审批量变化趋势 |

### 6.2 超时统计

- 按审批人维度统计超时次数
- 超时TOP排行
- 超时原因分析（可配置标签）

---

## 七、数据权限

- 审批流程配置：仅系统管理员可操作
- 审批任务：仅相关人员可见（发起人、审批人、抄送人）
- 审批统计：受ABAC策略控制，管理层可查看团队统计
- 审批数据存储：全量审批记录永久保存，用于审计

---

## 八、非功能需求

| 项目 | 要求 |
|------|------|
| 性能 | 流程实例创建 < 500ms；审批操作响应 < 1s |
| 并发 | 支持100+审批流程同时运行 |
| 可用性 | 审批引擎高可用，不因单点故障导致审批阻塞 |
| 通知及时性 | 审批任务产生后30s内推送通知 |
| 移动端 | 完整支持移动端审批操作 |
