# ABAC权限设计 — 产品需求文档

> 所属模块：基础功能
> 文档版本：v1.0
> 创建日期：2026-02-25
> 最后更新：2026-02-25
> 文档编号：1-10

---

## 一、功能概述

### 1.1 功能定位

ABAC（Attribute-Based Access Control，基于属性的访问控制）是旗舰版系统的**权限基座**，替代原有RBAC角色权限体系，为全部业务模块提供统一的权限决策能力。

### 1.2 核心价值

| 价值维度 | 说明 |
|---------|------|
| **集团级管控** | 支持集团总部统筹查看所有园区数据，园区之间数据严格隔离 |
| **多园区隔离** | 不同园区作为独立数据域，互不可见，支持独立运营 |
| **灵活策略** | 支持基于用户属性、资源属性、操作属性、环境属性的动态组合策略 |
| **精细粒度** | 支持功能级、数据级、字段级、行操作级四层权限控制 |
| **安全合规** | 内置安全熔断、异常行为检测、操作审计追踪 |

### 1.3 目标用户

| 用户角色 | 使用场景 |
|---------|---------|
| 超级管理员 | 配置ABAC策略规则、管理角色模板、安全审计 |
| 集团管理层 | 跨园区统筹查看数据、经营决策 |
| 园区管理层 | 管辖范围内的全量数据查看与管理 |
| 部门负责人 | 部门范围内的数据管理与团队协作 |
| 普通员工 | 个人负责数据的日常操作 |

### 1.4 与其他模块的关系

ABAC权限引擎为以下所有模块提供统一权限决策服务：

```
                        ┌──────────────┐
                        │  ABAC策略引擎  │
                        │   (PDP核心)   │
                        └──────┬───────┘
          ┌────────┬──────┬────┴───┬──────┬───────┬──────┬──────┐
          ▼        ▼      ▼       ▼      ▼       ▼      ▼      ▼
      ┌──────┐┌──────┐┌──────┐┌──────┐┌──────┐┌──────┐┌──────┐┌──────┐
      │载体  ││招商  ││客商  ││合同  ││财务  ││物业  ││会员  ││报表  │
      │管理  ││管理  ││管理  ││管理  ││管理  ││管理  ││管理  ││中心  │
      └──────┘└──────┘└──────┘└──────┘└──────┘└──────┘└──────┘└──────┘
```

---

## 二、组织架构与多园区模型

### 2.1 集团-园区组织拓扑

```
┌──────────────────────────────────────────────────────────────────────┐
│                        集团总部（Group）                              │
│                     tenant_id = T001                                │
│                                                                     │
│  ┌─ 集团管理层 ─────────────────────────────────────────────────┐    │
│  │  · 集团董事长/总裁    → 全部园区全部数据可见                    │    │
│  │  · 集团财务总监       → 全部园区财务数据可见                    │    │
│  │  · 集团招商总监       → 全部园区招商数据可见                    │    │
│  │  · 集团运营总监       → 全部园区运营数据可见                    │    │
│  └──────────────────────────────────────────────────────────────┘    │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│  │  园区A        │  │  园区B        │  │  园区C        │   ... N个园区 │
│  │  park_id=P01 │  │  park_id=P02 │  │  park_id=P03 │               │
│  │              │  │              │  │              │               │
│  │ ┌──────────┐ │  │ ┌──────────┐ │  │ ┌──────────┐ │               │
│  │ │招商部    │ │  │ │招商部    │ │  │ │招商部    │ │               │
│  │ │运营部    │ │  │ │运营部    │ │  │ │运营部    │ │               │
│  │ │财务部    │ │  │ │财务部    │ │  │ │财务部    │ │               │
│  │ │物业部    │ │  │ │物业部    │ │  │ │物业部    │ │               │
│  │ └──────────┘ │  │ └──────────┘ │  │ └──────────┘ │               │
│  └──────────────┘  └──────────────┘  └──────────────┘               │
└──────────────────────────────────────────────────────────────────────┘
```

### 2.2 园区隔离模型

| 隔离维度 | 规则 | 说明 |
|---------|------|------|
| **数据隔离** | 每条业务数据归属一个 `park_id` | 载体、合同、账单、线索等均绑定园区 |
| **默认不可见** | 用户仅能看到自己管辖园区的数据 | 除非策略显式授权跨园区 |
| **集团穿透** | 集团角色通过策略规则穿透园区隔离 | 只读聚合或全量访问 |
| **跨园区协作** | 通过"管辖园区"属性实现 | 一个用户可管辖多个园区 |

### 2.3 部门层级与数据归属

```
部门（最深9级）数据归属规则：

  部门A
   ├── 子部门A-1
   │    ├── 子部门A-1-1
   │    └── 子部门A-1-2
   └── 子部门A-2

数据权限范围：
  · 本人数据      → 仅 创建人/负责人 == 当前用户
  · 本部门数据    → 资源.所属部门 == 用户.部门
  · 本部门及下属  → 资源.所属部门 IN 用户.部门及所有子部门
  · 本园区数据    → 资源.所属园区 == 用户.管辖园区
  · 全部数据      → 不做数据过滤（集团级/超管）
  · 指定部门      → 资源.所属部门 IN 手动指定的部门列表
  · 指定园区      → 资源.所属园区 IN 手动指定的园区列表
```

---

## 三、ABAC四维属性模型

### 3.1 主体属性（Subject Attributes）

| 属性名称 | 属性键 | 类型 | 来源 | 说明 |
|---------|--------|------|------|------|
| 用户ID | `sub.user_id` | String | 系统 | 唯一标识 |
| 用户姓名 | `sub.user_name` | String | 组织架构 | 展示用 |
| 所属单位 | `sub.tenant_id` | String | 系统 | 多租户隔离顶层 |
| 所属部门 | `sub.dept_id` | String | 组织架构 | 当前部门 |
| 所属部门路径 | `sub.dept_path` | String[] | 组织架构 | 部门全路径（含上级链） |
| 管辖园区 | `sub.managed_parks` | String[] | 人员配置 | 用户被授权管辖的园区列表 |
| 职位 | `sub.position` | String | 组织架构 | 如：招商经理、财务主管 |
| 职级 | `sub.job_level` | Enum | 组织架构 | 员工/主管/经理/总监/VP/总裁 |
| 角色标签 | `sub.role_tags` | String[] | 角色分配 | 如：["集团管理员","招商管理","财务管理"] |
| 入职年限 | `sub.tenure_years` | Number | 组织架构 | 自动计算 |
| 在职状态 | `sub.status` | Enum | 组织架构 | 在职/离职 |
| 组织层级 | `sub.org_level` | Enum | 组织架构 | 集团总部/园区/部门 |

### 3.2 资源属性（Resource Attributes）

| 属性名称 | 属性键 | 类型 | 来源 | 说明 |
|---------|--------|------|------|------|
| 资源类型 | `res.type` | Enum | 系统 | park/building/room/lead/project/client/contract/bill/receipt/invoice/meter_reading 等 |
| 所属园区 | `res.park_id` | String | 业务数据 | 该资源归属的园区 |
| 所属部门 | `res.dept_id` | String | 业务数据 | 该资源归属的部门 |
| 创建人 | `res.creator_id` | String | 业务数据 | 创建该资源的用户 |
| 负责人 | `res.owner_id` | String | 业务数据 | 当前负责该资源的用户 |
| 数据密级 | `res.sensitivity` | Enum | 业务/配置 | 公开/内部/机密/绝密 |
| 金额区间 | `res.amount_range` | Enum | 业务数据 | 按合同/账单金额自动计算：<10万/10-100万/>100万/>500万 |
| 客商类型 | `res.client_type` | Enum | 业务数据 | 潜在客户/租客/供应商 |
| 合同状态 | `res.contract_status` | Enum | 业务数据 | 待执行/执行中/已到期/已退租/已作废 |
| 资源状态 | `res.status` | String | 业务数据 | 各业务实体的当前状态 |
| 字段名 | `res.field_name` | String | 系统 | 用于字段级权限控制 |

### 3.3 操作属性（Action Attributes）

| 属性名称 | 属性键 | 类型 | 可选值 | 说明 |
|---------|--------|------|--------|------|
| 操作类型 | `act.type` | Enum | view/create/edit/delete/export/import/approve/assign/transfer/print/publish | 系统内所有操作动词 |
| 操作批量性 | `act.batch` | Boolean | true/false | 是否批量操作 |
| 导出数量 | `act.export_count` | Number | — | 导出时的记录条数 |

### 3.4 环境属性（Environment Attributes）

| 属性名称 | 属性键 | 类型 | 来源 | 说明 |
|---------|--------|------|------|------|
| 访问时间 | `env.time` | DateTime | 系统 | 请求发生时间 |
| 是否工作时段 | `env.is_work_hours` | Boolean | 系统 | 工作日09:00-18:00为true |
| 访问IP | `env.ip` | String | 系统 | 请求来源IP |
| 设备类型 | `env.device` | Enum | 系统 | pc/mobile/tablet |
| 客户端类型 | `env.client` | Enum | 系统 | web/app/miniprogram |
| GPS坐标 | `env.gps` | LatLng | 移动端 | 移动端GPS定位 |
| 网络类型 | `env.network` | Enum | 系统 | internal/vpn/public |

---

## 四、角色模板体系（RBAC兼容层）

### 4.1 设计原则

角色 = 一组**预设的主体属性标签集合** + 一组**预绑定的策略规则集合**。角色模板是策略管理的**便捷入口**，降低管理员的配置复杂度。管理员既可直接使用角色模板，也可跳过角色直接为用户配置属性和策略。

### 4.2 系统预置角色模板

#### 4.2.1 集团级角色

| 角色模板名称 | 角色标签 | 组织层级 | 管辖范围 | 适用场景 |
|-------------|---------|---------|---------|---------|
| 集团超级管理员 | `["super_admin","group_admin"]` | 集团总部 | 全部园区 | 系统最高权限，配置ABAC策略 |
| 集团总裁/董事长 | `["group_leader"]` | 集团总部 | 全部园区 | 全部数据只读 + 报表看板 |
| 集团招商总监 | `["group_leader","investment_mgr"]` | 集团总部 | 全部园区 | 全部园区招商数据查看 |
| 集团财务总监 | `["group_leader","finance_mgr"]` | 集团总部 | 全部园区 | 全部园区财务数据查看 |
| 集团运营总监 | `["group_leader","operation_mgr"]` | 集团总部 | 全部园区 | 全部园区运营/物业数据查看 |
| 集团数据分析师 | `["group_analyst"]` | 集团总部 | 全部园区 | 全部园区报表只读，敏感字段脱敏 |

#### 4.2.2 园区级角色

| 角色模板名称 | 角色标签 | 组织层级 | 管辖范围 | 适用场景 |
|-------------|---------|---------|---------|---------|
| 园区总经理 | `["park_admin"]` | 园区 | 本园区 | 本园区全部数据的管理权限 |
| 招商部经理 | `["investment_mgr"]` | 园区 | 本部门及下属 | 招商模块管理 + 本部门数据 |
| 招商专员 | `["investment_staff"]` | 园区 | 本人 | 招商模块操作 + 本人数据 |
| 运营部经理 | `["operation_mgr"]` | 园区 | 本部门及下属 | 载体/物业管理 + 本部门数据 |
| 运营专员 | `["operation_staff"]` | 园区 | 本人 | 载体/物业操作 + 本人数据 |
| 财务部经理 | `["finance_mgr"]` | 园区 | 本园区 | 财务管理全权限 + 本园区数据 |
| 财务专员 | `["finance_staff"]` | 园区 | 本人 | 财务操作 + 本人数据 |
| 合同管理员 | `["contract_mgr"]` | 园区 | 本园区 | 合同全流程管理 |
| 客服/物业员 | `["property_staff"]` | 园区 | 本园区 | 物业管理 + 客商基础信息查看 |
| 只读观察员 | `["readonly"]` | 园区 | 本园区 | 全模块只读，无任何编辑权限 |

### 4.3 自定义角色

管理员可基于预置模板创建自定义角色：

- 复制预置角色模板，修改角色标签组合
- 手动调整绑定的策略规则集
- 自定义数据范围（管辖园区/部门）
- 角色数量不限

---

## 五、全模块权限策略矩阵

### 5.1 权限点定义规则

每个权限点由三元组定义：`模块.功能.操作`

格式：`{module}.{feature}.{action}`

### 5.2 模块1：基础功能

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 部门经理 | 普通员工 |
|--------|------|------|---------|-----------|---------|---------|
| `base.org.view` | 查看组织架构 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本部门) |
| `base.org.edit` | 编辑组织架构 | ✅ | ❌ | ✅(本园区) | ❌ | ❌ |
| `base.dept.create` | 新建部门 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `base.dept.edit` | 编辑部门 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `base.dept.delete` | 删除部门 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `base.employee.create` | 新建员工 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `base.employee.edit` | 编辑员工 | ✅ | ❌ | ✅ | ✅(本部门) | ❌ |
| `base.employee.dismiss` | 员工离职 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `base.employee.data_transfer` | 离职数据继承 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `base.role.manage` | 角色/策略管理 | ✅ | ❌ | ✅(本园区) | ❌ | ❌ |
| `base.abac.manage` | ABAC策略配置 | ✅ | ❌ | ❌ | ❌ | ❌ |
| `base.brand.edit` | 品牌配置 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `base.dynamic_form.manage` | 动态表单配置 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `base.audit_log.view` | 查看审计日志 | ✅ | ✅(全部) | ✅(本园区) | ❌ | ❌ |
| `base.profile.edit` | 编辑个人信息 | ✅ | ✅ | ✅ | ✅ | ✅ |

### 5.3 模块2：载体管理

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 运营经理 | 招商专员 | 运营专员 |
|--------|------|------|---------|-----------|---------|---------|---------|
| `carrier.park.view` | 查看园区 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区,只读) | ✅(本园区) |
| `carrier.park.create` | 新建园区 | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| `carrier.park.edit` | 编辑园区 | ✅ | ❌ | ✅ | ✅ | ❌ | ✅ |
| `carrier.park.delete` | 删除园区 | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| `carrier.building.view` | 查看建筑 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区,只读) | ✅(本园区) |
| `carrier.building.create` | 新建建筑 | ✅ | ❌ | ✅ | ✅ | ❌ | ✅ |
| `carrier.building.edit` | 编辑建筑 | ✅ | ❌ | ✅ | ✅ | ❌ | ✅ |
| `carrier.building.delete` | 删除建筑 | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| `carrier.room.view` | 查看房源 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区,只读) | ✅(本园区) |
| `carrier.room.create` | 新建房源 | ✅ | ❌ | ✅ | ✅ | ❌ | ✅ |
| `carrier.room.edit` | 编辑房源 | ✅ | ❌ | ✅ | ✅ | ❌ | ✅ |
| `carrier.room.delete` | 删除房源 | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| `carrier.section_view.view` | 查看剖面图 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区) | ✅(本园区) |
| `carrier.section_view.config` | 剖面图配置 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `carrier.publish.operate` | 载体发布 | ✅ | ❌ | ✅ | ✅ | ❌ | ✅ |
| `carrier.publish.feedback` | 查看发布反馈 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区) | ✅(本园区) |
| `carrier.tag.manage` | 载体标签管理 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `carrier.type.manage` | 载体类型管理 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `carrier.data_config.manage` | 数据配置 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `carrier.export` | 导出载体数据 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |

### 5.4 模块3：招商管理

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 招商经理 | 招商专员 |
|--------|------|------|---------|-----------|---------|---------|
| `invest.lead.view` | 查看线索 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |
| `invest.lead.create` | 新建线索 | ✅ | ❌ | ✅ | ✅ | ✅ |
| `invest.lead.edit` | 编辑线索 | ✅ | ❌ | ✅ | ✅(本部门及下属) | ✅(本人) |
| `invest.lead.delete` | 删除线索 | ✅ | ❌ | ✅ | ✅(本部门及下属) | ❌ |
| `invest.lead.assign` | 分配线索 | ✅ | ❌ | ✅ | ✅(本部门及下属) | ❌ |
| `invest.lead.transfer` | 转移线索 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `invest.lead.recycle` | 回收线索 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `invest.lead.to_project` | 线索转项目 | ✅ | ❌ | ✅ | ✅ | ✅(本人) |
| `invest.lead.export` | 导出线索 | ✅ | ✅ | ✅ | ✅ | ❌ |
| `invest.lead.import` | 导入线索 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `invest.project.view` | 查看项目 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |
| `invest.project.create` | 新建项目 | ✅ | ❌ | ✅ | ✅ | ✅ |
| `invest.project.edit` | 编辑项目 | ✅ | ❌ | ✅ | ✅(本部门及下属) | ✅(本人) |
| `invest.project.delete` | 删除项目 | ✅ | ❌ | ✅ | ✅(本部门及下属) | ❌ |
| `invest.project.assign` | 分配项目 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `invest.project.recycle` | 回收项目 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `invest.project.issue` | 项目问题管理 | ✅ | ✅(只读) | ✅ | ✅ | ✅(本人项目) |
| `invest.project.export` | 导出项目 | ✅ | ✅ | ✅ | ✅ | ❌ |
| `invest.online_match.view` | 查看在线对接 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |
| `invest.call_record.view` | 查看通话记录 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |
| `invest.network.view` | 查看人脉 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |
| `invest.contact_person.manage` | 招商联系人管理 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `invest.recycle_bin.view` | 查看回收站 | ✅ | ❌ | ✅ | ✅ | ✅(本人) |
| `invest.recycle_bin.restore` | 回收站恢复 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `invest.config.manage` | 招商配置管理 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `invest.lead_scoring.view` | 查看线索评分 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |
| `invest.ai_report.view` | 查看AI报告 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |

### 5.5 模块4：客商管理（CRM）

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 部门经理 | 普通员工 |
|--------|------|------|---------|-----------|---------|---------|
| `crm.client.view` | 查看客商 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |
| `crm.client.create` | 新建客商 | ✅ | ❌ | ✅ | ✅ | ✅ |
| `crm.client.edit` | 编辑客商 | ✅ | ❌ | ✅ | ✅(本部门及下属) | ✅(本人) |
| `crm.client.delete` | 删除客商 | ✅ | ❌ | ✅ | ✅(本部门及下属) | ❌ |
| `crm.client.merge` | 合并客商 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `crm.client.transfer` | 转移客商负责人 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `crm.client.export` | 导出客商 | ✅ | ✅ | ✅ | ✅ | ❌ |
| `crm.client.import` | 导入客商 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `crm.prospect.view` | 查看潜在客户 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人+共享) |
| `crm.tenant.view` | 查看租客 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |
| `crm.supplier.view` | 查看供应商 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区,只读) |
| `crm.contact.view` | 查看联系人 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人客商下) |
| `crm.contact.create` | 新建联系人 | ✅ | ❌ | ✅ | ✅ | ✅ |
| `crm.contact.edit` | 编辑联系人 | ✅ | ❌ | ✅ | ✅(本部门及下属) | ✅(本人客商下) |
| `crm.contact.delete` | 删除联系人 | ✅ | ❌ | ✅ | ✅(本部门及下属) | ❌ |
| `crm.contact.call` | 拨打联系人电话 | ✅ | ❌ | ✅ | ✅ | ✅ |
| `crm.contact.export` | 导出联系人 | ✅ | ✅ | ✅ | ✅ | ❌ |
| `crm.contact.import` | 导入联系人 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `crm.industry.manage` | 行业管理 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `crm.tag.manage` | 客商标签管理 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `crm.credit.view` | 查看信用画像 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ❌ |

### 5.6 模块5：合同管理

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 合同管理员 | 招商专员 | 财务专员 |
|--------|------|------|---------|-----------|-----------|---------|---------|
| `contract.list.view` | 查看合同列表 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人) | ✅(本园区) |
| `contract.create` | 新建合同 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ |
| `contract.edit` | 编辑合同 | ✅ | ❌ | ✅ | ✅ | ✅(本人,仅待执行) | ❌ |
| `contract.delete` | 删除合同 | ✅ | ❌ | ✅ | ✅(仅待执行) | ❌ | ❌ |
| `contract.change` | 合同变更 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `contract.renew` | 合同续租 | ✅ | ❌ | ✅ | ✅ | ✅(本人) | ❌ |
| `contract.terminate` | 合同退租 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `contract.void` | 合同作废 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `contract.approve` | 合同审批 | ✅ | ✅(>100万) | ✅ | ❌ | ❌ | ❌ |
| `contract.print` | 打印合同 | ✅ | ❌ | ✅ | ✅ | ✅(本人) | ❌ |
| `contract.print_template.manage` | 打印模板管理 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `contract.export` | 导出合同 | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ |
| `contract.tag.manage` | 合同标签管理 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `contract.clause_type.manage` | 条款类型管理 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `contract.reminder.manage` | 到期提醒配置 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `contract.terminate_reason.manage` | 退租原因管理 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `contract.history.view` | 查看合同操作历史 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人) | ✅(本园区) |
| `contract.cashflow.view` | 查看现金流预览 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人) | ✅(本园区) |
| `contract.bottom_price.view` | 查看合同底价 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |

### 5.7 模块6：财务管理

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 财务经理 | 财务专员 | 招商专员 |
|--------|------|------|---------|-----------|---------|---------|---------|
| `finance.bill.view` | 查看账单 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人/本部门) | ✅(本人客商) |
| `finance.bill.create` | 新建账单（手动） | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ |
| `finance.bill.edit` | 编辑账单 | ✅ | ❌ | ✅ | ✅ | ✅(仅未收) | ❌ |
| `finance.bill.delete` | 删除账单 | ✅ | ❌ | ✅ | ✅(仅未收) | ❌ | ❌ |
| `finance.bill.export` | 导出账单 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| `finance.notice.view` | 查看通知单 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人/本部门) | ❌ |
| `finance.notice.create` | 生成通知单 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ |
| `finance.notice.send` | 发送通知单 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ |
| `finance.receipt.view` | 查看收据 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人/本部门) | ❌ |
| `finance.receipt.create` | 开具收据 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ |
| `finance.receipt.void` | 作废收据 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `finance.receipt.export` | 导出收据 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| `finance.invoice.view` | 查看发票 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人/本部门) | ❌ |
| `finance.invoice.create` | 开具发票 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ |
| `finance.invoice.void` | 作废发票 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `finance.invoice.export` | 导出发票 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| `finance.flow.view` | 查看收支流水 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人/本部门) | ❌ |
| `finance.flow.export` | 导出流水 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| `finance.fee_type.manage` | 费用类型管理 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `finance.company.manage` | 公司主体管理 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `finance.revenue_rule.manage` | 收入确认规则 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `finance.im_push.send` | IM推送账单 | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ |
| `finance.online_pay.manage` | 在线支付管理 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |
| `finance.overdue_amount.view` | 查看逾期金额 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人) | ❌ |

### 5.8 模块7：物业管理

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 运营经理 | 物业专员 |
|--------|------|------|---------|-----------|---------|---------|
| `property.meter_reading.view` | 查看抄表记录 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区) |
| `property.meter_reading.create` | 新增抄表 | ✅ | ❌ | ✅ | ✅ | ✅ |
| `property.meter_reading.edit` | 编辑抄表 | ✅ | ❌ | ✅ | ✅ | ✅(本人) |
| `property.meter_reading.delete` | 删除抄表 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `property.meter_reading.export` | 导出抄表记录 | ✅ | ✅ | ✅ | ✅ | ❌ |
| `property.meter_reading.import` | 导入抄表记录 | ✅ | ❌ | ✅ | ✅ | ✅ |
| `property.meter_reading.approve` | 抄表审核 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `property.meter_type.manage` | 表种类管理 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `property.price.manage` | 价格标准管理 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `property.price.view` | 查看价格标准 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区) |
| `property.alert.view` | 查看能耗预警 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区) |
| `property.alert.config` | 预警规则配置 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `property.energy_dashboard.view` | 查看能源画像 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ❌ |
| `property.tvi.view` | 查看经营活力指数 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ❌ |

### 5.9 模块8：会员管理

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 部门经理 | 普通员工 |
|--------|------|------|---------|-----------|---------|---------|
| `member.manage` | 会员管理 | ✅ | ✅(只读) | ✅ | ❌ | ❌ |
| `member.level.config` | 会员等级配置 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `member.rights.config` | 会员权益配置 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `member.ai_ambassador.config` | 数字人配置 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `member.ai_quality.view` | AI语音质检查看 | ✅ | ✅(全部) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |

### 5.10 模块9：报表中心

| 权限点 | 说明 | 超管 | 集团领导 | 集团分析师 | 园区总经理 | 部门经理 | 普通员工 |
|--------|------|------|---------|-----------|-----------|---------|---------|
| `report.investment_funnel.view` | 招商漏斗看板 | ✅ | ✅(全部) | ✅(全部,脱敏) | ✅(本园区) | ✅(本部门及下属) | ❌ |
| `report.asset_operation.view` | 资产经营看板 | ✅ | ✅(全部) | ✅(全部,脱敏) | ✅(本园区) | ❌ | ❌ |
| `report.tenant_portrait.view` | 租客画像看板 | ✅ | ✅(全部) | ✅(全部,脱敏) | ✅(本园区) | ✅(本部门及下属) | ❌ |
| `report.staff_performance.view` | 人效看板 | ✅ | ✅(全部) | ✅(全部,脱敏) | ✅(本园区) | ✅(本部门及下属) | ✅(本人) |
| `report.noi.view` | NOI/资产估值 | ✅ | ✅(全部) | ✅(全部,脱敏) | ✅(本园区) | ❌ | ❌ |
| `report.cashflow_forecast.view` | 现金流预测 | ✅ | ✅(全部) | ✅(全部,脱敏) | ✅(本园区) | ❌ | ❌ |
| `report.leader_cockpit.view` | 领导驾驶舱 | ✅ | ✅(全部) | ❌ | ✅(本园区) | ❌ | ❌ |
| `report.cross_park_compare.view` | 跨园区对比分析 | ✅ | ✅(全部) | ✅(全部,脱敏) | ❌ | ❌ | ❌ |
| `report.export` | 导出报表 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| `report.custom.create` | 自定义报表 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ |

### 5.11 模块10：渠道管理

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 招商经理 | 招商专员 |
|--------|------|------|---------|-----------|---------|---------|
| `channel.agent.view` | 查看中介备案 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本园区,只读) |
| `channel.agent.create` | 新建中介备案 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `channel.agent.edit` | 编辑中介备案 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `channel.agent.approve` | 审核中介备案 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `channel.lead_dedup.view` | 线索判重查看 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人) |
| `channel.commission.view` | 查看佣金 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ✅(本人推荐) |
| `channel.commission.calculate` | 佣金计算 | ✅ | ❌ | ✅ | ✅ | ❌ |
| `channel.commission.approve` | 佣金审批 | ✅ | ✅(>阈值) | ✅ | ❌ | ❌ |
| `channel.settlement.manage` | 结算单据管理 | ✅ | ✅(全部) | ✅(本园区) | ✅(本园区) | ❌ |

### 5.12 全局功能权限

| 权限点 | 说明 | 超管 | 集团领导 | 园区总经理 | 部门经理 | 普通员工 |
|--------|------|------|---------|-----------|---------|---------|
| `global.approval.manage` | 审批流程管理 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `global.approval.process` | 处理审批 | ✅ | ✅ | ✅ | ✅ | ✅(被指定时) |
| `global.notification.manage` | 通知规则管理 | ✅ | ❌ | ✅ | ❌ | ❌ |
| `global.notification.view` | 查看通知 | ✅ | ✅ | ✅ | ✅ | ✅ |
| `global.ai_assistant.use` | 使用AI助手 | ✅ | ✅ | ✅ | ✅ | ✅ |
| `global.transfer_record.view` | 查看传输记录 | ✅ | ✅ | ✅ | ✅ | ✅(本人) |
| `global.workbench.view` | 查看工作台 | ✅ | ✅ | ✅ | ✅ | ✅ |

---

## 六、核心策略规则库

### 6.1 园区隔离策略（系统内置，不可删除）

| 策略ID | 策略名称 | 规则表达式 | 效果 | 优先级 |
|--------|---------|-----------|------|--------|
| SYS-001 | 租户顶层隔离 | `sub.tenant_id == res.tenant_id` | Permit前置条件（必须满足） | 最高 |
| SYS-002 | 园区数据隔离 | `res.park_id IN sub.managed_parks` | Permit | 高 |
| SYS-003 | 部门数据隔离 | `res.dept_id IN sub.dept_path` | Permit | 中 |
| SYS-004 | 本人数据限定 | `res.creator_id == sub.user_id OR res.owner_id == sub.user_id` | Permit | 中 |

### 6.2 集团穿透策略

| 策略ID | 策略名称 | 规则表达式 | 效果 |
|--------|---------|-----------|------|
| GRP-001 | 集团管理员全局可见 | `"super_admin" IN sub.role_tags` | Permit（全部资源） |
| GRP-002 | 集团领导全局只读 | `"group_leader" IN sub.role_tags AND act.type == "view"` | Permit（跨园区） |
| GRP-003 | 集团招商总监跨园区 | `"group_leader" IN sub.role_tags AND "investment_mgr" IN sub.role_tags AND res.type IN ["lead","project","client","online_match","call_record"]` | Permit（只读） |
| GRP-004 | 集团财务总监跨园区 | `"group_leader" IN sub.role_tags AND "finance_mgr" IN sub.role_tags AND res.type IN ["bill","receipt","invoice","flow","contract"]` | Permit（只读） |
| GRP-005 | 集团运营总监跨园区 | `"group_leader" IN sub.role_tags AND "operation_mgr" IN sub.role_tags AND res.type IN ["park","building","room","meter_reading"]` | Permit（只读） |
| GRP-006 | 集团分析师脱敏查看 | `"group_analyst" IN sub.role_tags AND act.type == "view"` | Permit（全部资源 + 敏感字段脱敏） |

### 6.3 业务场景策略

| 策略ID | 策略名称 | 规则表达式 | 效果 |
|--------|---------|-----------|------|
| BIZ-001 | 大额合同审批路由 | `res.type == "contract" AND res.amount_range IN [">100万",">500万"] AND act.type == "approve"` | 路由至更高审批节点 |
| BIZ-002 | 潜在客户跨部门共享 | `res.type == "client" AND res.client_type == "prospect" AND "investment_staff" IN sub.role_tags AND act.type == "view"` | Permit（只读） |
| BIZ-003 | 合同底价保护 | `res.type == "contract" AND res.field_name == "bottom_price" AND sub.job_level < "总监"` | Hidden |
| BIZ-004 | 作废合同只读 | `res.type == "contract" AND res.contract_status == "已作废" AND act.type IN ["edit","delete"]` | Deny |
| BIZ-005 | 已收账单不可删除 | `res.type == "bill" AND res.status IN ["已收","部分已收"] AND act.type == "delete"` | Deny |
| BIZ-006 | 离职员工数据冻结 | `sub.status == "离职"` | Deny（全部操作） |
| BIZ-007 | 联系人手机号脱敏 | `res.type == "contact" AND res.field_name == "phone" AND sub.job_level < "经理" AND res.owner_id != sub.user_id` | 脱敏（中间4位***） |

### 6.4 安全防护策略

| 策略ID | 策略名称 | 规则表达式 | 效果 |
|--------|---------|-----------|------|
| SEC-001 | 非工作时间批量导出 | `act.type == "export" AND env.is_work_hours == false AND act.export_count > 100` | Deny + 熔断账号 + 通知超管 |
| SEC-002 | 异地IP敏感操作 | `env.ip NOT IN sub.常用IP集 AND res.sensitivity IN ["机密","绝密"]` | Deny + 二次验证 + 告警 |
| SEC-003 | 频繁权限试探 | `过去10分钟内 Deny次数 > 10` | 临时冻结30分钟 + 通知安全管理员 |
| SEC-004 | 大额操作强制审计 | `res.type == "contract" AND res.amount_range IN [">100万",">500万"]` | 强制记录详细操作日志 |
| SEC-005 | 公网批量下载限速 | `env.network == "public" AND act.type == "export" AND act.export_count > 500` | 排队 + 限速 |
| SEC-006 | 移动端位置校验 | `act.type == "meter_reading" AND env.device == "mobile" AND GPS距离(env.gps, res.building_gps) > 500米` | Deny + 提示"距离过远" |

---

## 七、字段级权限控制

### 7.1 字段权限动作

| 动作 | 说明 |
|------|------|
| **Visible** | 正常可见 |
| **Hidden** | 完全隐藏（字段不展示，API不返回） |
| **Masked** | 脱敏展示（如手机号 138****5678） |
| **ReadOnly** | 可见但不可编辑 |

### 7.2 全模块敏感字段清单

| 模块 | 字段 | 默认权限 | 脱敏/隐藏条件 | 可见范围 |
|------|------|---------|-------------|---------|
| **客商管理** | 联系人手机号 | Visible | 非负责人且职级<经理 → Masked | 负责人+经理及以上 |
| **客商管理** | 联系人身份证号 | Hidden | 默认Hidden | 仅超管+合同管理员 |
| **客商管理** | 企业银行账号 | Hidden | 默认Hidden | 仅财务经理及以上 |
| **客商管理** | 信用评分 | Visible | 职级<经理 → Hidden | 经理及以上 |
| **合同管理** | 合同底价 | Hidden | 默认Hidden | 总监及以上 |
| **合同管理** | 合同金额 | Visible | 集团分析师 → Masked(区间) | 合同相关角色 |
| **合同管理** | 押金金额 | Visible | 无关人员 → Hidden | 合同负责人+财务 |
| **财务管理** | 逾期金额 | Visible | 招商专员 → Hidden | 财务+管理层 |
| **财务管理** | 银行账号 | Masked | 默认Masked | 财务经理及以上完整展示 |
| **财务管理** | 发票税号 | Visible | 非财务角色 → Hidden | 财务角色 |
| **招商管理** | 线索评分（内部） | Visible | 外部渠道中介 → Hidden | 内部员工 |
| **招商管理** | AI健康度报告 | Visible | 普通员工 → 仅本人项目 | 经理及以上全部 |
| **报表中心** | 具体收入金额 | Visible | 集团分析师 → Masked(区间) | 管理层+财务 |
| **报表中心** | 人效排名明细 | Visible | 跨部门 → 仅看汇总 | 本部门经理看明细 |
| **物业管理** | 价格标准底价 | Hidden | 默认Hidden | 运营经理及以上 |

---

## 八、数据范围策略详细设计

### 8.1 数据范围类型定义

| 范围类型 | 代码 | SQL等价过滤 | 适用场景 |
|---------|------|------------|---------|
| 本人 | `SELF` | `WHERE (creator_id = :userId OR owner_id = :userId)` | 普通员工默认 |
| 本部门 | `DEPT` | `WHERE dept_id = :deptId` | 部门内横向协作 |
| 本部门及下属 | `DEPT_CASCADE` | `WHERE dept_id IN (:deptIdAndChildren)` | 部门经理管理 |
| 本园区 | `PARK` | `WHERE park_id IN (:managedParkIds)` | 园区级管理 |
| 全部园区 | `ALL` | 不添加过滤 | 集团级查看 |
| 指定部门 | `DESIGNATED_DEPT` | `WHERE dept_id IN (:designatedDeptIds)` | 跨部门协作 |
| 指定园区 | `DESIGNATED_PARK` | `WHERE park_id IN (:designatedParkIds)` | 跨园区管理 |

### 8.2 各模块默认数据范围

| 模块 | 资源类型 | 园区总经理 | 部门经理 | 普通员工 |
|------|---------|-----------|---------|---------|
| 载体管理 | 园区/建筑/房源 | PARK | PARK | PARK(只读) |
| 招商管理 | 线索 | PARK | DEPT_CASCADE | SELF |
| 招商管理 | 项目 | PARK | DEPT_CASCADE | SELF |
| 招商管理 | 在线对接/通话记录 | PARK | DEPT_CASCADE | SELF |
| 客商管理 | 客商(租客/供应商) | PARK | DEPT_CASCADE | SELF |
| 客商管理 | 潜在客户 | PARK | DEPT_CASCADE | SELF+共享 |
| 客商管理 | 联系人 | PARK | DEPT_CASCADE | SELF(客商下) |
| 合同管理 | 合同 | PARK | DEPT_CASCADE | SELF |
| 财务管理 | 账单/收据/发票/流水 | PARK | PARK | DEPT |
| 物业管理 | 抄表记录 | PARK | PARK | PARK |
| 会员管理 | 会员 | PARK | — | — |
| 报表中心 | 看板数据 | PARK | DEPT_CASCADE | SELF(人效) |
| 渠道管理 | 中介/佣金 | PARK | PARK | SELF(推荐) |

### 8.3 集团级聚合查看规则

```
集团领导查看报表时的数据聚合逻辑：

                    ┌────────────────────────┐
                    │    集团领导驾驶舱         │
                    │                        │
                    │  ┌──── 园区选择器 ────┐  │
                    │  │ ☑ 全部园区（默认）  │  │
                    │  │ ☐ 园区A           │  │
                    │  │ ☐ 园区B           │  │
                    │  │ ☐ 园区C           │  │
                    │  └──────────────────┘  │
                    │                        │
                    │  选"全部"→ 数据自动聚合  │
                    │  选单个  → 下钻该园区    │
                    └────────────────────────┘

聚合规则：
  · 数值指标（出租率/应收/逾期等）：各园区汇总 or 加权平均
  · 排名指标（人效/转化率等）：跨园区对比排名
  · 明细数据：展示园区维度汇总行，点击可下钻
  · 敏感字段：集团分析师看到脱敏版（金额区间化，人名首字脱敏）
```

---

## 九、策略管理后台（PAP）

### 9.1 策略管理页面

#### 9.1.1 入口

设置 → 权限管理 → ABAC策略配置（仅超级管理员可见）
 
#### 9.1.2 策略列表

| 字段 | 说明 |
|------|------|
| 策略ID | 系统自动生成 |
| 策略名称 | 管理员命名 |
| 策略类型 | 系统内置 / 自定义 |
| 策略分类 | 园区隔离 / 集团穿透 / 业务场景 / 安全防护 |
| 规则描述 | 自然语言描述 |
| 状态 | 启用 / 停用 / 草稿 |
| 优先级 | 1-999（数字越小优先级越高） |
| 最后修改时间 | — |
| 修改人 | — |

#### 9.1.3 策略编辑器（可视化规则构建器）

```
┌──────────────────────────────────────────────────────────────────┐
│  策略编辑器                                                      │
│                                                                  │
│  策略名称：[                               ]                     │
│  策略描述：[                               ]                     │
│                                                                  │
│  ┌─ 条件组（AND/OR切换）────────────────────────────────────┐    │
│  │                                                          │    │
│  │  条件1: [ 主体属性 ▼] [ 角色标签  ▼] [ 包含 ▼] [招商管理] │    │
│  │    AND                                                   │    │
│  │  条件2: [ 操作属性 ▼] [ 操作类型  ▼] [ 等于 ▼] [查看    ] │    │
│  │    AND                                                   │    │
│  │  条件3: [ 资源属性 ▼] [ 资源类型  ▼] [ 等于 ▼] [线索    ] │    │
│  │                                                          │    │
│  │  [+ 添加条件]  [+ 添加条件组]                              │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
│  执行效果: ( ○ 允许  ○ 拒绝  ○ 脱敏  ○ 只读 )                    │
│                                                                  │
│  数据范围: [ 本人 / 本部门 / 本部门及下属 / 本园区 / 全部 ▼]       │
│                                                                  │
│  优先级:   [     50    ]                                         │
│                                                                  │
│  [保存草稿]   [测试策略]   [发布]                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 9.2 角色模板管理

#### 9.2.1 角色列表

| 字段 | 说明 |
|------|------|
| 角色名称 | 如"招商经理" |
| 角色类型 | 系统预置 / 自定义 |
| 组织层级 | 集团级 / 园区级 |
| 关联策略数 | 该角色绑定的策略条数 |
| 关联用户数 | 使用该角色的用户数 |
| 状态 | 启用 / 停用 |

#### 9.2.2 角色编辑

```
┌──────────────────────────────────────────────────────────────────┐
│  角色编辑                                                        │
│                                                                  │
│  角色名称：[  招商部经理                    ]                      │
│  角色描述：[  负责招商部日常管理和团队管理      ]                    │
│  组织层级：( ○ 集团级  ● 园区级 )                                  │
│                                                                  │
│  ┌─ 角色标签 ──────────────────────────────┐                     │
│  │  ☑ investment_mgr  (招商管理)           │                     │
│  │  ☐ finance_mgr     (财务管理)           │                     │
│  │  ☐ operation_mgr   (运营管理)           │                     │
│  │  ☐ group_leader    (集团领导)           │                     │
│  │  ...                                    │                     │
│  └─────────────────────────────────────────┘                     │
│                                                                  │
│  ┌─ 功能权限 ──────────────────────────────┐                     │
│  │                                          │                     │
│  │  ▼ 招商管理                               │                     │
│  │    ☑ 查看线索  ☑ 新建线索  ☑ 编辑线索     │                     │
│  │    ☑ 删除线索  ☑ 分配线索  ☑ 导出线索     │                     │
│  │    ☑ 转移线索  ☑ 回收线索                 │                     │
│  │  ▼ 载体管理                               │                     │
│  │    ☑ 查看园区  ☐ 新建园区  ☐ 编辑园区     │                     │
│  │    ☑ 查看建筑  ☐ 新建建筑  ☐ 编辑建筑     │                     │
│  │    ☑ 查看房源  ☐ 新建房源  ☐ 编辑房源     │                     │
│  │  ▼ 客商管理                               │                     │
│  │    ☑ 查看客商  ☑ 新建客商  ☑ 编辑客商     │                     │
│  │  ...                                      │                     │
│  └──────────────────────────────────────────┘                     │
│                                                                  │
│  ┌─ 数据范围 ──────────────────────────────┐                     │
│  │  线索/项目：    [本部门及下属 ▼]           │                     │
│  │  客商：         [本部门及下属 ▼]           │                     │
│  │  合同：         [本部门及下属 ▼]           │                     │
│  │  财务数据：     [本园区 ▼]  (只读)         │                     │
│  │  载体数据：     [本园区 ▼]  (只读)         │                     │
│  └──────────────────────────────────────────┘                     │
│                                                                  │
│  [取消]   [保存]                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 9.3 用户权限分配

#### 9.3.1 分配方式

| 方式 | 说明 | 适用场景 |
|------|------|---------|
| **角色分配** | 为用户分配一个或多个角色模板 | 标准场景，推荐使用 |
| **策略覆写** | 在角色基础上，为特定用户追加或排除策略 | 特殊场景微调 |
| **管辖园区指定** | 在用户属性中指定管辖园区列表 | 跨园区管理人员 |
| **临时授权** | 设置有效期的临时权限 | 项目协作、临时支援 |

#### 9.3.2 用户权限分配页面

```
┌──────────────────────────────────────────────────────────────────┐
│  用户权限配置 — 张三                                               │
│                                                                  │
│  基础信息：                                                       │
│  部门：园区A - 招商部                                              │
│  职位：招商经理                                                    │
│  职级：经理                                                       │
│                                                                  │
│  ┌─ 角色分配 ──────────────────────────────┐                     │
│  │  ☑ 招商部经理                            │                     │
│  │  ☐ 园区总经理                            │                     │
│  │  ☐ 合同管理员                            │                     │
│  │  ...                                    │                     │
│  └─────────────────────────────────────────┘                     │
│                                                                  │
│  ┌─ 管辖园区 ──────────────────────────────┐                     │
│  │  ☑ 园区A（主属园区）                      │                     │
│  │  ☑ 园区B（兼管）                          │                     │
│  │  ☐ 园区C                                 │                     │
│  └─────────────────────────────────────────┘                     │
│                                                                  │
│  ┌─ 策略覆写（可选）────────────────────────┐                     │
│  │  + 追加策略：可查看园区B的招商数据（只读）   │                     │
│  │  - 排除策略：无                            │                     │
│  └─────────────────────────────────────────┘                     │
│                                                                  │
│  ┌─ 临时授权（可选）────────────────────────┐                     │
│  │  无临时授权                               │                     │
│  │  [+ 新增临时授权]                          │                     │
│  └─────────────────────────────────────────┘                     │
│                                                                  │
│  [权限预览]  [保存]                                                │
└──────────────────────────────────────────────────────────────────┘
```

### 9.4 权限预览与测试

管理员可在配置完成后，通过"权限预览"功能模拟该用户的实际权限效果：

```
┌──────────────────────────────────────────────────────────────────┐
│  权限预览 — 模拟用户：张三                                         │
│                                                                  │
│  模拟模块：[招商管理 ▼]  模拟操作：[查看线索 ▼]                     │
│  模拟园区：[园区A ▼]     模拟时间：[当前 ▼]                         │
│                                                                  │
│  [执行模拟]                                                       │
│                                                                  │
│  ┌─ 模拟结果 ──────────────────────────────────────────────┐     │
│  │                                                          │     │
│  │  决策结果：✅ 允许                                        │     │
│  │                                                          │     │
│  │  命中策略链：                                             │     │
│  │  1. SYS-001 租户顶层隔离    → ✅ 通过                    │     │
│  │  2. SYS-002 园区数据隔离    → ✅ 通过（园区A在管辖范围）   │     │
│  │  3. SYS-003 部门数据隔离    → ✅ 通过（本部门及下属）     │     │
│  │  4. BIZ-007 联系人手机号脱敏 → ⚠️ 脱敏（非负责人数据）    │     │
│  │                                                          │     │
│  │  可见数据范围：本部门及下属部门的线索（共 128 条）           │     │
│  │  脱敏字段：联系人手机号（非本人负责的线索）                  │     │
│  └──────────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────────┘
```

---

## 十、策略决策引擎流程

### 10.1 策略评估流程

```
用户发起请求
      │
      ▼
┌──────────────┐
│ PEP 拦截请求  │ ← API网关层
│ 提取请求上下文 │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────┐
│ PIP 属性查询                                                  │
│                                                               │
│ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐           │
│ │ 主体属性查询  │ │ 资源属性查询  │ │ 环境属性采集  │           │
│ │              │ │              │ │              │           │
│ │ user_id      │ │ res.type     │ │ 当前时间     │           │
│ │ dept_id      │ │ res.park_id  │ │ 请求IP      │           │
│ │ role_tags    │ │ res.owner_id │ │ 设备类型     │           │
│ │ managed_parks│ │ res.sensitivity│ │ GPS坐标    │           │
│ │ job_level    │ │ res.amount   │ │              │           │
│ └──────────────┘ └──────────────┘ └──────────────┘           │
└──────────────────────────┬───────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│ PDP 策略决策引擎                                               │
│                                                               │
│  Step 1: 系统内置策略检查                                      │
│    SYS-001 租户隔离 → 不通过则直接 Deny                         │
│    SYS-002 园区隔离 → 检查管辖园区                              │
│                                                               │
│  Step 2: 集团穿透策略检查                                      │
│    GRP-001~006 → 集团角色可跳过园区隔离                         │
│                                                               │
│  Step 3: 功能权限检查                                          │
│    act.type + res.type → 是否有该操作权限                       │
│                                                               │
│  Step 4: 数据范围过滤                                          │
│    生成数据过滤条件（SELF/DEPT/PARK/ALL等）                      │
│                                                               │
│  Step 5: 字段级权限检查                                        │
│    逐字段检查 → 生成 Visible/Hidden/Masked/ReadOnly 指令         │
│                                                               │
│  Step 6: 安全策略检查                                          │
│    SEC-001~006 → 环境异常检测                                   │
│                                                               │
│  Step 7: 合并决策结果                                          │
│    优先级规则：Deny > 安全熔断 > 脱敏 > 只读 > Permit            │
└──────────────────────────┬───────────────────────────────────┘
                           │
                           ▼
┌──────────────┐
│ PEP 执行决策  │
│              │
│ · Permit → 放行请求                           │
│ · Deny   → 返回403 + 拒绝原因                 │
│ · 脱敏    → 放行请求 + 附加字段脱敏指令         │
│ · 只读    → 放行请求 + 标记只读                 │
│ · 熔断    → 冻结账号 + 通知超管                │
└──────────────┘
```

### 10.2 策略冲突解决规则

| 冲突场景 | 解决规则 | 说明 |
|---------|---------|------|
| 同一请求命中多条策略 | **Deny优先** | 任何一条Deny即最终Deny |
| 多条Permit策略 | **取并集** | 数据范围取并集，功能权限取并集 |
| Permit + 脱敏策略 | **Permit + 脱敏** | 允许访问但敏感字段脱敏 |
| 角色策略 + 用户覆写策略 | **覆写优先** | 用户级覆写覆盖角色级策略 |
| 临时授权 + 永久策略 | **临时授权优先** | 临时授权在有效期内覆盖永久策略 |
| 优先级相同的冲突策略 | **更安全方优先** | Deny > Masked > ReadOnly > Permit |

### 10.3 性能优化

| 优化措施 | 说明 |
|---------|------|
| **策略缓存** | 用户属性 + 角色策略编译为决策矩阵，缓存至Redis，TTL=5分钟 |
| **增量更新** | 策略变更时仅刷新受影响用户的缓存 |
| **预计算数据范围** | 用户登录时预计算数据范围SQL片段，存入会话 |
| **批量评估** | 列表查询时批量评估字段级权限，避免逐行评估 |
| **延迟加载** | 环境属性（GPS/IP归属地等）仅在需要时查询 |

---

## 十一、典型场景验证

### 场景1：集团董事长查看全部园区经营数据

```
主体：sub.role_tags = ["group_leader"], sub.org_level = "集团总部"
操作：act.type = "view"
资源：res.type = "report"
环境：env.device = "pc"

策略链：
  SYS-001 → ✅ 同一租户
  GRP-002 → ✅ 集团领导全局只读 → 跳过园区隔离
  功能权限 → ✅ report.*.view
  字段权限 → 全部Visible（集团领导不脱敏）

结果：允许查看全部园区报表，数据自动聚合
```

### 场景2：园区A招商专员查看线索

```
主体：sub.role_tags = ["investment_staff"], sub.managed_parks = ["P01"]
操作：act.type = "view"
资源：res.type = "lead"
环境：env.device = "pc"

策略链：
  SYS-001 → ✅ 同一租户
  SYS-002 → ✅ res.park_id = "P01" IN sub.managed_parks
  SYS-004 → ✅ 本人数据（数据范围 = SELF）
  功能权限 → ✅ invest.lead.view
  字段权限 → BIZ-007 联系人手机号脱敏（非本人负责的线索）

结果：仅看到自己负责的线索，他人线索中联系人手机号脱敏
```

### 场景3：园区A招商专员尝试查看园区B数据

```
主体：sub.role_tags = ["investment_staff"], sub.managed_parks = ["P01"]
操作：act.type = "view"
资源：res.park_id = "P02"

策略链：
  SYS-001 → ✅ 同一租户
  SYS-002 → ❌ res.park_id = "P02" NOT IN sub.managed_parks = ["P01"]

结果：Deny — 无权访问园区B的数据（数据隔离生效）
```

### 场景4：非工作时间批量导出

```
主体：sub.role_tags = ["finance_staff"]
操作：act.type = "export", act.export_count = 500
资源：res.type = "bill"
环境：env.is_work_hours = false, env.time = "23:30"

策略链：
  SYS-001 → ✅
  SYS-002 → ✅
  功能权限 → ❌ finance.bill.export 未授予财务专员
  SEC-001 → ❌ 非工作时间 + 导出>100条

结果：Deny + 熔断账号 + 短信通知超管
```

### 场景5：跨园区管理人员

```
主体：sub.role_tags = ["investment_mgr"], sub.managed_parks = ["P01","P02"]
操作：act.type = "view"
资源：res.type = "lead"

策略链：
  SYS-001 → ✅
  SYS-002 → ✅ res.park_id IN ["P01","P02"]
  数据范围 → DESIGNATED_PARK(P01,P02) + DEPT_CASCADE

结果：可查看园区A和园区B两个园区的招商线索数据
```

### 场景6：潜在客户跨部门共享

```
主体：sub.role_tags = ["investment_staff"], sub.dept_id = "D001"
操作：act.type = "view"
资源：res.type = "client", res.client_type = "prospect", res.dept_id = "D002"

策略链：
  SYS-001 → ✅
  SYS-002 → ✅
  SYS-003 → ❌ res.dept_id = "D002" NOT IN sub.dept_path
  BIZ-002 → ✅ 潜在客户 + 招商人员 → 跨部门共享（只读）

结果：允许只读查看其他部门的潜在客户
```

---

## 十二、离职与数据继承

### 12.1 离职数据继承规则

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 员工状态改为"离职" | 触发 BIZ-006 策略，账号立即冻结 |
| 2 | 弹出数据继承配置 | 管理员指定继承人 |
| 3 | 批量转移负责人 | 线索、项目、客商、合同的 owner_id 批量更新为继承人 |
| 4 | 操作日志记录 | 记录所有数据转移明细 |
| 5 | 通知继承人 | 站内信 + 短信通知继承人有新数据接手 |

### 12.2 继承范围

| 数据类型 | 继承方式 |
|---------|---------|
| 线索（负责人） | 转移给继承人 |
| 项目（负责人） | 转移给继承人 |
| 客商（负责人） | 转移给继承人 |
| 合同（创建人） | 标记原创建人，负责人转移给继承人 |
| 通话记录/在线对接 | 保留原归属人，新增"原员工"标记 |
| 操作日志 | 不转移，保留原记录 |

---

## 十三、审计与合规

### 13.1 权限操作审计日志

所有权限相关操作必须记录审计日志：

| 记录事件 | 记录内容 |
|---------|---------|
| 角色创建/编辑/删除 | 操作人、变更前后内容 |
| 用户角色分配/变更 | 操作人、目标用户、变更前后角色 |
| 策略创建/编辑/启停 | 操作人、策略内容、变更前后对比 |
| 权限拒绝事件 | 请求人、请求内容、命中策略、拒绝原因 |
| 安全熔断事件 | 触发人、触发条件、处理结果 |
| 临时授权创建/过期 | 授权人、被授权人、授权内容、有效期 |

### 13.2 合规报告

系统自动生成以下合规报告（按月/季/年）：

| 报告名称 | 内容 |
|---------|------|
| 权限变更报告 | 期间内所有角色/策略/权限变更记录 |
| 越权尝试报告 | 期间内所有权限拒绝事件汇总 |
| 敏感数据访问报告 | 期间内机密/绝密数据的访问记录 |
| 导出行为报告 | 期间内所有数据导出行为汇总 |
| 安全事件报告 | 期间内所有安全熔断/告警事件 |

---

## 十四、非功能需求

### 14.1 性能要求

| 指标 | 要求 |
|------|------|
| 策略评估延迟 | 单次评估 < 10ms（缓存命中时 < 2ms） |
| 并发承载 | 支持 500 并发策略评估 |
| 缓存命中率 | > 95% |
| 策略数量上限 | 单租户 1000 条策略 |

### 14.2 可用性要求

| 指标 | 要求 |
|------|------|
| 策略引擎可用性 | 99.9%（降级策略：引擎不可用时执行默认Deny） |
| 策略变更生效时间 | < 30秒（缓存刷新） |
| 策略回滚 | 支持一键回滚到任意历史版本 |

### 14.3 安全要求

| 要求 | 说明 |
|------|------|
| 策略编辑权限 | 仅超级管理员可编辑ABAC策略 |
| 策略版本管理 | 所有策略变更保留完整历史版本 |
| 策略发布审核 | 自定义策略发布前需二次确认 |
| 系统策略保护 | 系统内置策略不可删除，不可停用 |

---

## 十五、版本记录

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| v1.0 | 2026-02-25 | 初始版本，完整ABAC权限设计 | — |
