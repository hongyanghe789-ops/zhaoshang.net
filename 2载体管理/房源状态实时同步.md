# 房源状态实时同步

> **文档编号**：PRD-2-15
> **所属模块**：载体管理
> **优先级**：P0
> **版本**：v1.0
> **最后更新**：2026-02-27
> **关联文档**：房源列表.pdf、载体发布.pdf、合同列表.pdf、合同历史—操作内容信息&其他--状态机.pdf

---

## 一、功能概述

### 1.1 背景与目标

目前房源状态变更与招商网络平台的同步存在延迟和断裂，导致平台展示信息不准确（如房源已签约但平台仍显示可租）。本功能实现**房源状态与合同审批流程的全链路实时同步**，包括合同审批→房源锁定→平台同步→成交喜报的完整闭环。

### 1.2 核心价值

- 消除平台信息滞后，提升客户体验
- 自动化状态联动，减少人工操作
- 成交喜报营造热销氛围，促进转化

---

## 二、状态同步链路

### 2.1 完整状态机

```
┌──────────────────────────────────────────────────────────┐
│                    房源状态实时同步全链路                     │
│                                                          │
│  合同事件                房源状态           平台状态          │
│  ─────────              ─────────         ─────────      │
│                                                          │
│  合同创建(草稿)    →    无变化          →   无变化          │
│                                                          │
│  合同提交审批      →    [锁定/谈判中]   →   "洽谈中"        │
│                          ↓                  (不可预约)     │
│  审批通过/合同生效  →    [在租]          →   下架房源        │
│                          ↓                  + 成交喜报     │
│  审批拒绝          →    [释放→空置]     →   恢复"可租"      │
│                                                          │
│  合同退租申请       →    标记"即将空出"  →   "即将腾退"      │
│                                            (可预订)       │
│  退租完成          →    [空置]          →   恢复"可租"      │
│                                                          │
│  合同到期未续租     →    预招商触发       →   "近期腾退"     │
│                          (参考2-14)        (可预订)       │
└──────────────────────────────────────────────────────────┘
```

### 2.2 同步触发点

| 序号 | 触发事件 | 房源状态变更 | 平台同步动作 | 通知 |
|------|---------|-------------|-------------|------|
| 1 | 合同提交审批 | 空置→锁定/谈判中 | API推送：房源状态="洽谈中" | 通知房源负责人 |
| 2 | 合同审批通过 | 锁定→在租 | API推送：下架房源 | — |
| 3 | 合同生效 | 保持在租 | 生成成交喜报轮播 | 推送成交喜报 |
| 4 | 合同审批拒绝 | 锁定→空置(释放) | API推送：恢复"可租" | 通知房源负责人 |
| 5 | 退租申请提交 | 在租（标记即将空出） | API推送：状态="即将腾退，可预订" | 触发预招商 |
| 6 | 退租完成 | 在租→空置 | API推送：恢复"可租" | — |

---

## 三、锁定机制

### 3.1 锁定规则

| 规则 | 说明 |
|------|------|
| 锁定触发 | 合同提交审批的瞬间，关联房源自动锁定 |
| 锁定效果 | 其他合同无法绑定该房源（提示"该房源已被合同XX锁定"） |
| 锁定释放 | 审批拒绝/合同撤回/合同作废 → 自动释放 |
| 超时释放 | 锁定超过N天（可配置，默认30天）未完成审批 → 自动释放+通知 |
| 并发控制 | 同一房源同一时刻仅允许一份合同锁定 |

### 3.2 锁定状态展示

- 剖面图：锁定房源显示紫色 + 🔒图标
- 房源列表：状态列显示"锁定/谈判中"（紫色标签）
- 房源详情：顶部提示"该房源已被合同 [HT-2026-001] 锁定"

---

## 四、成交喜报

### 4.1 触发条件

合同状态变为"执行中"（审批通过且生效）时，自动生成成交喜报。

### 4.2 喜报内容

```
┌──────────────────────────────────┐
│  🎉 成交喜报                      │
│                                  │
│  恭喜【创新产业园 · A栋301】       │
│  成功签约！                       │
│                                  │
│  签约面积：500㎡                   │
│  签约企业：某某科技有限公司          │
│  签约日期：2026-02-27             │
│                                  │
│  园区累计出租率：87.5%             │
└──────────────────────────────────┘
```

### 4.3 喜报展示位置

| 位置 | 展示形式 |
|------|---------|
| 招商网络平台 | 载体详情页轮播横幅 |
| 旗舰版工作台 | 成交动态滚动条 |
| 剖面图 | 新成交房源闪烁动画（3秒） |

### 4.4 隐私保护

- 签约企业名称默认脱敏（如"某*科技"），可在系统设置中关闭脱敏
- 签约金额不展示
- 喜报可在系统设置中开启/关闭

---

## 五、平台同步API

### 5.1 同步接口

| 接口 | 方向 | 说明 |
|------|------|------|
| 房源状态更新 | 旗舰版→平台 | 推送房源状态变更 |
| 成交喜报推送 | 旗舰版→平台 | 推送成交信息 |
| 同步结果回调 | 平台→旗舰版 | 确认同步成功/失败 |

### 5.2 同步失败处理

| 场景 | 处理 |
|------|------|
| 网络超时 | 自动重试3次，间隔10s/30s/60s |
| 持续失败 | 记入同步失败队列，通知管理员 |
| 数据冲突 | 以旗舰版数据为准，覆盖平台数据 |

---

## 六、系统配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 锁定超时天数 | 超过N天未完成审批自动释放 | 30天 |
| 成交喜报开关 | 是否生成成交喜报 | 开启 |
| 喜报脱敏 | 企业名称是否脱敏 | 开启 |
| 同步重试次数 | 同步失败最大重试次数 | 3次 |

---

## 七、非功能需求

| 项目 | 要求 |
|------|------|
| 同步延迟 | 状态变更后 < 5s 完成平台推送 |
| 锁定并发 | 乐观锁机制防止并发锁定冲突 |
| 同步可靠性 | 至少一次投递保证 |
