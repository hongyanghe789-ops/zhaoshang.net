# 消息通知中心

> **文档编号**：PRD-0-2
> **所属模块**：全局功能
> **优先级**：P0
> **版本**：v1.0
> **最后更新**：2026-02-27
> **关联文档**：全局配置文件.md、审批工作流引擎.md

---

## 一、功能概述

### 1.1 背景与目标

旗舰版系统中各模块（合同到期提醒、账单逾期通知、审批催办、报修进度等）均需消息通知能力，当前缺乏统一的消息中心。本功能建设**统一消息通知中心**，收纳全系统提醒/审批/推送，支持多渠道触达，触发规则可配置。

### 1.2 核心价值

- 统一消息入口，避免各模块独立实现通知逻辑
- 多渠道触达：站内信 + 短信 + 微信 + UL App推送
- 触发规则可配置，业务人员可自行调整通知策略
- 消息模板管理，规范通知内容格式

---

## 二、系统架构

```
┌────────────────────────────────────────────────────────┐
│                    消息通知中心                           │
│                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 触发规则引擎  │  │ 消息模板管理  │  │ 渠道路由引擎  │  │
│  │              │  │              │  │              │  │
│  │ 事件监听     │  │ 模板CRUD     │  │ 站内信       │  │
│  │ 条件判断     │  │ 变量占位符   │  │ 短信(SMS)    │  │
│  │ 防骚扰策略   │  │ 多语言(预留) │  │ 微信(服务号) │  │
│  └──────┬───────┘  └──────────────┘  │ UL App推送   │  │
│         │                            └──────────────┘  │
│         ▼                                              │
│  ┌──────────────┐  ┌──────────────┐                    │
│  │ 消息队列     │  │ 消息收件箱   │                    │
│  │ (异步发送)   │  │ (站内信中心) │                    │
│  └──────────────┘  └──────────────┘                    │
└────────────────────────────────────────────────────────┘
```

---

## 三、消息类型

### 3.1 类型分类

| 消息类型 | 图标 | 说明 | 典型场景 |
|---------|------|------|---------|
| **审批通知** | 🔔 | 审批任务提醒 | 待审批、审批结果、超时催办 |
| **业务提醒** | 📋 | 业务状态变更提醒 | 合同到期、账单逾期、房源状态变更 |
| **系统通知** | ⚙️ | 系统级通知 | 导入完成、导出完成、系统公告 |
| **预警告警** | ⚠️ | 预警类通知 | 水电异常、信用预警、安全告警 |
| **运营通知** | 📢 | 运营管理相关 | 报修进度、巡检异常、访客到访 |

### 3.2 消息来源（事件触发源）

| 来源模块 | 触发事件 | 默认渠道 |
|---------|---------|---------|
| 合同管理 | 合同到期提醒（30/15/7天） | 站内信+短信 |
| 合同管理 | 合同审批结果 | 站内信+UL推送 |
| 财务管理 | 账单逾期提醒 | 站内信+短信+IM推送 |
| 财务管理 | 收款确认通知 | 站内信 |
| 招商管理 | 线索超时未跟进 | 站内信+UL推送 |
| 招商管理 | 项目节点超时 | 站内信+短信 |
| 载体管理 | 预招商触发通知 | 站内信+UL推送 |
| 载体管理 | 房源状态变更 | 站内信 |
| 物业管理 | 水电异常预警 | 站内信+短信 |
| 运营管理 | 报修工单状态变更 | 站内信+UL推送 |
| 运营管理 | 巡检异常上报 | 站内信+短信 |
| 运营管理 | 访客到访通知 | 站内信+UL推送 |
| 审批引擎 | 新审批任务 | 站内信+UL推送 |
| 审批引擎 | 超时催办 | 站内信+短信+UL推送 |
| 安全审计 | 异常操作告警 | 站内信+短信 |

---

## 四、触发规则配置

### 4.1 规则管理

**入口**：系统设置 → 消息通知 → 触发规则

每条规则包含：

| 配置项 | 说明 |
|--------|------|
| 规则名称 | 如"合同到期30天提醒" |
| 触发事件 | 选择事件类型（合同到期、账单逾期等） |
| 触发条件 | 可选条件过滤（如：金额>10万的合同才触发） |
| 通知对象 | 负责人/部门主管/指定角色/自定义 |
| 通知渠道 | 勾选：站内信/短信/微信/UL推送 |
| 通知频次 | 单次/重复（间隔N天/N小时） |
| 启用状态 | 启用/停用 |

### 4.2 防骚扰策略

| 策略 | 说明 |
|------|------|
| 同类消息合并 | 同一事件同一接收人，短时间内（如1小时）只发送一次 |
| 每日上限 | 单人每日短信通知不超过10条 |
| 免打扰时段 | 22:00 ~ 08:00 不发送短信/UL推送（站内信不受限） |
| 手动屏蔽 | 用户可对特定类型消息设置"仅站内信" |

---

## 五、消息模板管理

### 5.1 模板结构

| 字段 | 说明 |
|------|------|
| 模板编号 | 系统自动生成 |
| 模板名称 | 如"合同到期提醒" |
| 消息类型 | 审批通知/业务提醒/系统通知/预警告警/运营通知 |
| 适用渠道 | 站内信/短信/微信/UL推送（不同渠道可不同模板内容） |
| 模板标题 | 支持变量占位符，如"合同【{contractNo}】将于{expireDate}到期" |
| 模板正文 | 支持变量占位符+富文本（站内信）/ 纯文本（短信） |
| 跳转链接 | 点击消息后跳转的业务页面URL（站内信/UL推送） |

### 5.2 变量占位符

| 变量 | 说明 | 示例 |
|------|------|------|
| {contractNo} | 合同编号 | HT-2026-001 |
| {tenantName} | 租客名称 | 某某科技有限公司 |
| {roomName} | 房源名称 | A栋-3层-301 |
| {amount} | 金额 | ¥50,000.00 |
| {expireDate} | 到期日期 | 2026-06-30 |
| {operatorName} | 操作人 | 张三 |
| {parkName} | 园区名称 | 创新产业园 |

---

## 六、消息收件箱（站内信中心）

### 6.1 PC端

**入口**：顶部导航栏"消息"铃铛图标（带红色未读角标）

**功能**：
- 消息列表：按时间倒序，支持按类型筛选
- 未读/已读标记
- 一键全部已读
- 点击消息→跳转到关联业务页面
- 消息设置：管理个人通知偏好

### 6.2 移动端（UL小程序）

- 复用UL App推送通道
- 推送通知→点击进入小程序对应页面
- 小程序内消息中心与PC端数据同步

---

## 七、渠道对接

### 7.1 站内信

- 系统内消息中心直接投递
- 支持富文本内容+跳转链接
- 无需外部服务依赖

### 7.2 短信（SMS）

- 对接短信服务商API
- 短信内容受字数限制（70字/条）
- 需用户绑定手机号
- 费用按条计费

### 7.3 微信推送

- 对接微信服务号模板消息
- 需用户关注公司微信服务号并绑定账号
- 受微信模板消息规范限制

### 7.4 UL App推送

- 复用User Link App的推送通道
- 支持富文本+跳转小程序页面
- 需用户安装UL App并登录

---

## 八、数据权限

- 消息仅接收人可见
- 触发规则配置：系统管理员
- 消息模板管理：系统管理员
- 个人通知偏好：用户自行设置

---

## 九、非功能需求

| 项目 | 要求 |
|------|------|
| 消息投递延迟 | 事件触发后30s内完成投递 |
| 短信到达率 | > 99% |
| 消息存储 | 站内信保留180天，超期自动归档 |
| 并发 | 支持1000+消息/分钟的投递能力 |
